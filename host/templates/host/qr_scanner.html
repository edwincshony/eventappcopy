{% extends "accounts/base.html" %}

{% block title %}QR Code Scanner | EventApp{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0"><i class="bi bi-qr-code-scan"></i> QR Code Scanner</h2>
                </div>
                <div class="card-body">
                    <p class="text-muted">Allow camera access to start scanning guest tickets.</p>

                    <!-- QR Reader -->
                    <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>

                    <!-- Scan Again Button -->
                    <div id="scan-again-section" class="text-center mt-3" style="display: none;">
                        <button id="scan-again-btn" class="btn btn-primary btn-lg">
                            <i class="bi bi-camera"></i> Scan Next Ticket
                        </button>
                    </div>

                    <!-- Result Display -->
                    <div id="qr-result" class="mt-4"></div>
                </div>
                <div class="card-footer text-center">
                    <a href="{% url 'host:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    const qrReader = new Html5Qrcode("qr-reader");
    let isScanning = false;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function startScanning() {
        isScanning = true;
        document.getElementById('scan-again-section').style.display = 'none';
        document.getElementById('qr-result').innerHTML = '<p class="text-info">üì∑ Ready to scan...</p>';

        qrReader.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess
        ).catch(err => {
            console.error('Camera error:', err);
            document.getElementById('qr-result').innerHTML = 
                '<div class="alert alert-danger">‚ùå Camera access denied. Please allow camera permissions.</div>';
        });
    }

    function stopScanning() {
        if (isScanning) {
            qrReader.stop().then(() => {
                isScanning = false;
                document.getElementById('scan-again-section').style.display = 'block';
            }).catch(err => console.error('Stop error:', err));
        }
    }

    function onScanSuccess(decodedText) {
        stopScanning();

        document.getElementById('qr-result').innerHTML = '<p class="text-info">‚è≥ Verifying ticket...</p>';

        const formData = new FormData();
        formData.append('qrdata', decodedText);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

        fetch('/host/verify-qr/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Content-Type:', response.headers.get('content-type'));
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned HTML instead of JSON. Check your URL configuration.');
            }
            
            return response.json();
        })
        .then(data => {
            console.log('JSON data:', data);
            const resultDiv = document.getElementById('qr-result');

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h4>${data.message}</h4>
                        <hr>
                        <p class="mb-1"><strong>Guest:</strong> ${data.guest}</p>
                        <p class="mb-1"><strong>Event:</strong> ${data.event}</p>
                        <p class="mb-1"><strong>Tickets:</strong> ${data.tickets}</p>
                        <p class="mb-0"><strong>Scanned At:</strong> ${data.scanned_at}</p>
                    </div>
                `;
            } else if (data.already_used) {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <h4>${data.message}</h4>
                        <hr>
                        <p class="mb-1"><strong>Guest:</strong> ${data.guest}</p>
                        <p class="mb-1"><strong>Event:</strong> ${data.event}</p>
                        <p class="mb-1"><strong>Tickets:</strong> ${data.tickets}</p>
                        <p class="mb-0"><strong>Previously Scanned:</strong> ${data.scanned_at}</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>‚ùå Verification Failed</h4>
                        <p class="mb-0">${data.message}</p>
                    </div>
                `;
            }
        })
        .catch(err => {
            console.error('Error:', err);
            document.getElementById('qr-result').innerHTML = `
                <div class="alert alert-danger">
                    <h4>‚ùå Error</h4>
                    <p class="mb-0">${err.message}</p>
                    <small class="text-muted">Check console for details</small>
                </div>
            `;
        });
    }

    document.getElementById('scan-again-btn').addEventListener('click', startScanning);

    // Auto-start
    startScanning();
</script>
{% endblock %}
